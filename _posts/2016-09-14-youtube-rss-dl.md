---
layout: post
title: "youtube-rss-dl"
description: "a ruby script to automatically download new videos from chosen YouTube channels"
date: 2016-09-14
comments: true
share: false
---

This is the project pipeline of a ruby script to automatically check and download new videos from chosen Youtube channels.

### Environment

* Ubuntu 16.04
* ruby 2.3.1
* [youtube-dl](https://rg3.github.io/youtube-dl/) 2016.08.31
* [pyxattr](http://pyxattr.k1024.org) 0.5.5
* [ffmpeg](https://ffmpeg.org) 2.8.6
* [simple-rss](https://github.com/cardmagic/simple-rss) 1.3.1
* [youtube-dl.rb](https://github.com/layer8x/youtube-dl.rb) 0.3.1.2016.08.31

### Tools

With a fresh Ubuntu 16.04 system, I choose to install the apt version of `ruby` and `pip`.

```
$ sudo apt-get install ruby-full python-pip
```

Through `pip` then, I got `youtube-dl` and `pyxattr`, which will be crucial to extract the metadata from YouTube and add them to the downloaded video. It requires a couple additional libraries and a tool.

```
$ sudo apt-get install libffi-dev libattr1-dev atomicparsley
$ sudo pip install youtube-dl pyxattr
```

Since Ubuntu 15, `ffmpeg` is back in the system packages. This tool will be necessary to convert the videos in the proper format.

```
$ sudo apt-get install ffmpeg
```

The two gems then:

`simple-rss` will parse the rss feed generated by YouTube. I choose to use an external gem instead of the standard library `RSS` because it didn't like the YouTube feed tags very much.

`youtube-dl.rb` will give us the ruby bindings for youtube-dl. The gems ships with a version of youtube-dl, but I preferred to install the pip version anyway to have the command line tool too.

```
sudo gem install simple-rss youtube-dl.rb
```

### Process

The whole script is a the end of the page.

Here I will break it in pieces to better understand the process, in case you want to add or change something.

#### Shebang

The script will be called regularly by cron, therefore we need to tell the shell this is a ruby script.

Use the `env` convention to make it portable and not guess where the ruby bin is located.

```ruby
#!/usr/bin/env ruby
```

#### Require statements

```ruby
require 'json'
require 'open-uri'
require 'simple-rss'
require 'youtube-dl.rb'
```

In addition to the two gems (`open-uri` is used with `simple-rss` to open the feed url), we'll need to manipulate a json to keep track of the downloaded videos.

#### YouTube channels
Here's the most customizable part: the YouTube channels you want to follow.

For each one of them, you need to get the `channel-external-id` tag in the source of the channel page. For example the [**Vsauce**](https://www.youtube.com/user/Vsauce) id is `UC6nSFpj9HTCZ5t-N3Rm3-HA`.

We will group them in an hash, where the key will be an arbitrary name (that will come handy to organize the json) and the value the actual channel id.

```ruby
CHANNELS = {
  'vsauce' => 'UC6nSFpj9HTCZ5t-N3Rm3-HA',
  'vihart' => 'UCOGeU-1Fig3rrDjhm9Zs_wg'
}
```

We can also declare a constant that will store the base url for the feed.

```ruby
RSS_BASE_URL = 'https://www.youtube.com/feeds/videos.xml?channel_id='
```

#### Destination folder
Another constant is the folder where the videos will be downloaded. I choose to keep them in the same folder where the script will be, and to avoid any trouble I stored it as an absolute path.

```ruby
DESTINATION = File.expand_path(File.dirname(__FILE__))
```

#### youtube-dl options

Another constant, and another customizable part. These are the options that will be passed to youtube-dl.

```ruby
YOUTUBEDL_OPTIONS = {
  force_ipv4: true,
  format: 'bestvideo[ext=mp4]+bestaudio[ext=m4a]',
  add_metadata: true,
  xattrs: true,
  embed_thumbnail: true,
  output: "#{DESTINATION}/%(uploader)s - %(upload_date)s - %(title)s.%(ext)s"
}
```

* I choose to force the connection via IPv4 because with my IPv6-enabled VPS I've had connectivity problems.
* The output format I prefer is mp4 at maximum quality: here `ffmpeg` will kick in to fulfill my desires.
* The downloaded video will have the proper metadata set thanks to `add_metadata` and `xattrs`...
* ...and a nice embedded thumbnail with `embed_thumbnail`.
* The output filename will be build with the template specified in `output`. Don't forget to prepend the destination folder, for you can't assume which will be the working directory of cron.

I choose to add the uploader name and the upload date to have the videos properly ordered.

The list of options is available [here](https://github.com/rg3/youtube-dl/blob/master/README.md#options). Keep in mind you'll need to rubify them, usually replacing `-` with `_` and converting single flags in hash elements with `true` or `false`.

#### JSON database

Along with the script, we'll keep a json file to keep track of the downloaded file, so to avoid downloading the same video over and over.

I keep the json in the same folder of the script with the name `youtube-dl.json`.

```ruby
json = File.join(File.dirname(__FILE__), 'youtube-dl.json')
```

When the script gets called the first time, or if we moved/deleted the json, there will be no database to read or to write to. To handle this, we'll write an empty hash to the file if no json is present.

```ruby
File.write(json, JSON.generate({})) unless File.file?(json)
```

Then, empty or not, we load the json to a variable.

```ruby
database = JSON.parse(File.read(json))
```

#### The main loop

Here's the core of the script. Keep in mind that, even if divided in pieces, this is a unique `each` method, so keep an eye for indentation and confront it with the uncommented script at the end.

First of all, we repeat the process for every channel, which in the script are the key-value pairs of the `CHANNELS` constant.

```ruby
CHANNELS.each do |channel_name, channel_id|
```

If we just added a channel, or if it's the first time we call the script, the channel name will not be present in the database. We declare it now then as an hash key with an empty array as value to which we will add, one by one, the downloaded videos id. The `||=` symbol will declare an empty array only if the variable doesn't have already a value.

```ruby
  database[channel_name] ||= []
```

It's time to parse the feed of the channel. Combine the YouTube base url with the channel id and...

```ruby
  rss = SimpleRSS.parse open(RSS_BASE_URL + channel_id)
```

The `rss` variable will hold an array of elements, usually between 1 and 15, which are the videos we're interested in. Among the various tags of the feed, we'll just need the `link`, to pass it to youtube-dl, and the `id`, to store it in the database as reference since it's unique.

So another loop, for every element in the feed:

```ruby
  rss.items.each do |video|
```

First, we look in the database if the id match an already downloaded video, so we can skip it.

```ruby
    next if database[channel_name].include?(video.id)
```

Then comes the download part. We just pass the video link and the options constant to `youtube-dl` which will do the magic.

```ruby
    YoutubeDL.download video.link, YOUTUBEDL_OPTIONS
```

Lastly, we add the id to the database and write it immediately to file in case something goes wrong.

```ruby
    database[channel_name] << video.id
    File.write(json, JSON.pretty_generate(database))
```

Wrap things up and print some infos. Done!

```ruby
    puts "#{channel_name}: #{video.title}"
  end
end
```

#### Cron

The final step is to setup a cron call to the script so the process happens automatically.

Grab the full path of the script, make it executable and choose the time. I set mine at 23:00 every day.

```
$ chmod +x /path/to/script/youtube-rss-dl.rb
$ crontab -e
```

```
0 23 * * * "/path/to/script/youtube-rss-dl.rb"
```

### Script

Here's the whole script with comments ([and here the maintained version](https://github.com/epistrephein/misc-scripts/blob/master/youtube-rss-dl/youtube-rss-dl.rb)).

```ruby
#!/usr/bin/env ruby

require 'json'
require 'open-uri'
require 'simple-rss'
require 'youtube-dl.rb'

CHANNELS = {
  'vsauce' => 'UC6nSFpj9HTCZ5t-N3Rm3-HA',
  'vihart' => 'UCOGeU-1Fig3rrDjhm9Zs_wg'
}

RSS_BASE_URL = 'https://www.youtube.com/feeds/videos.xml?channel_id='
DESTINATION = File.expand_path(File.dirname(__FILE__))
YOUTUBEDL_OPTIONS = {
  force_ipv4: true,
  format: 'bestvideo[ext=mp4]+bestaudio[ext=m4a]',
  add_metadata: true,
  xattrs: true,
  embed_thumbnail: true,
  output: "#{DESTINATION}/%(uploader)s - %(upload_date)s - %(title)s.%(ext)s"
}

# load/create database json
json = File.join(File.dirname(__FILE__), 'youtube-dl.json')
File.write(json, JSON.generate({})) unless File.file?(json)
database = JSON.parse(File.read(json))

# parse each channel
CHANNELS.each do |channel_name, channel_id|
  # check hash key
  database[channel_name] ||= []

  # get the feed
  rss = SimpleRSS.parse open(RSS_BASE_URL + channel_id)

  # parse each rss item
  rss.items.each do |video|
    next if database[channel_name].include?(video.id)

    # download video
    YoutubeDL.download video.link, YOUTUBEDL_OPTIONS

    # add video id to json
    database[channel_name] << video.id
    File.write(json, JSON.pretty_generate(database))

    puts "#{channel_name}: #{video.title}"
  end
end
```
